{% extends "base.html.twig" %}

{% set title = "Indicateurs d'activité des services" %}

{% block title %}{{ title }}{% endblock %}

{% block body %}

    <div class="container pt-4">
        <h1 class="h2 mb-3">{{ title }}</h1>
    </div>

    {% include "app/admin/indicator/_service_indicator_search.html.twig" %}
    
    <div class="container">
        <div class="row">
            <div class="col-md-12 table-responsive">
                <table id="table-services" class="table table-striped table-hover text-dark">
                    <thead>
                        <tr>
                            <th scope="row" class="align-middle th-w-140">Service</th>
                            {% set items = [
                                "Nb de TS",
                                "Nb de suivis mis à jour",
                                "Nb de notes créés", 
                                "Nb de rendez-vous créés", 
                                "Nb de documents créés", 
                                "Nb de paiements créés",
                            ] %}
                            {% for item in items %}
                                <th class="align-middle text-right th-w-100 w-min-80">{{ item }}</th>
                            {% endfor %}
                            <th class="align-middle th-w-20"></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% set sumActiveSupports = 0 %}
                    {% set sumNotes = 0 %}
                    {% set sumRdvs = 0 %}
                    {% set sumDocuments = 0 %}
                    {% set sumPaiments = 0 %}
                        {% for service_id, service in servicesIndicators %}  
                            {% set nbSupports = service["nbSupports"] %}
                            {% if nbSupports > 0 %}
                                {% set sumActiveSupports = sumActiveSupports + nbSupports %}
                                {% set sumNotes = sumNotes + service["nbNotes"] %}
                                {% set sumRdvs = sumRdvs + service["nbRdvs"] %}
                                {% set sumDocuments = sumDocuments + service["nbDocuments"] %}
                                {% set sumPaiments = sumPaiments + service["nbPayments"] %}
                                {% set nbTrCollapsed = service.subServices|length %}
                                <tr class="{{ nbTrCollapsed ? 'cursor-pointer' }}" data-toggle="collapse" data-target=".multi-collapse-service-{{ service_id }}" 
                                    aria-expanded="false" aria-controls="multi-collapse-service-{{ service_id }}">
                                    <td scope="row" class="align-middle"><span class="font-weight-bold">{{ service["name"] }}</span>
                                        {% if nbTrCollapsed %}<span class="badge badge-pill badge-secondary">{{ nbTrCollapsed }}</span>{% endif %}
                                    </td>
                                    <td class="align-middle text-right">{{ service["nbSocialWorkers"]|number }}</td>
                                    <td class="align-middle text-right">{{ nbSupports|number }}</td>
                                    <td class="align-middle text-right">{{ service["nbNotes"]|number }}</td>
                                    <td class="align-middle text-right">{{ service["nbRdvs"]|number }}</td>
                                    <td class="align-middle text-right">{{ service["nbDocuments"]|number }}</td>
                                    <td class="align-middle text-right">{{ service["nbPayments"]|number }}</td>
                                    <td></td>
                                </tr>
                                {% for sub_service_id, sub_service in service.subServices %}
                                    {% set nbSupports = sub_service["nbSupports"] %}
                                    <tr class="collapse multi-collapse-service-{{ service_id }}" id="multi-collapse-service-{{ service_id }}">
                                        <td scope="row" class="align-middle">{{ service["name"] }}<span class="fa fa-chevron-right mx-1"></span>{{ sub_service["name"] }}</td>
                                        <td class="align-middle text-right">-</td>
                                        <td class="align-middle text-right">{{ sub_service["nbSupports"]|number }}</td>
                                        <td class="align-middle text-right">{{ sub_service["nbNotes"]|number }}</td>
                                        <td class="align-middle text-right">{{ sub_service["nbRdvs"]|number }}</td>
                                        <td class="align-middle text-right">{{ sub_service["nbDocuments"]|number }}</td>
                                        <td class="align-middle text-right">{{ sub_service["nbPayments"]|number }}</td>
                                        <td></td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                    <tfooter>
                        <tr class="font-weight-bold">
                            <td class="align-middle text-center">Total</td>
                            <td class="align-middle text-right"></td>
                            <td class="align-middle text-right">{{ sumActiveSupports|number }}</td>
                            <td class="align-middle text-right">{{ sumNotes|number }}</td>
                            <td class="align-middle text-right">{{ sumRdvs|number }}</td>
                            <td class="align-middle text-right">{{ sumDocuments|number }}</td>
                            <td class="align-middle text-right">{{ sumPaiments|number }}</td>
                            <td></td>
                        </tr>
                    </tfooter>
                </table>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ encore_entry_script_tags("home") }}
    {{ encore_entry_script_tags("search") }}
{% endblock javascripts %}