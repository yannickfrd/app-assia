{% extends 'base.html.twig' %}

{% set title = 'Paiements' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}

    <section class="mt-0">

        <div class="container-fluid mt-4">
            {% include 'model/_msgFlash.html.twig' %}
            <div class="d-flex mb-3 align-items-center">
                <h1 class="h2 mr-1">{{ title }}</h1>
                <span class="text-secondary">(redevances, PF, caution...)</span>
            </div>
        </div>

        {% include 'app/payment/_payment_search_form.html.twig' %}

        <div class="container-fluid mt-4">

        <div class="row mb-2">
            <div class="col-md-12">
                <a href="{{ path('payment_indicators') }}" class="text-{{ theme_color }} float-right">
                    <span class="fas fa-chart-bar mr-2"></span>Indicateurs statistiques</a>
            </div>
        </div>

            <div class="row align-items-baseline">
                <div class="col-md-4 count align-middle mb-2">
                    <span class="align-middle">Résultat : {{ payments.getTotalItemCount|number }}<!--
                    --> entrée{% if payments.getTotalItemCount > 1 %}s{% endif %}.</span>
                </div>
                <div class="col-md-8">
                    <div class="navigation">{{ knp_pagination_render(payments) }}</div>
                </div>
            </div>

            <div class="table-responsive">
                <table id="table-payments" class="table table-striped table-bordered table-hover text-dark">
                    <thead>
                        <tr>
                            <th scope="col" class="align-middle th-w-20"></th>
                            <th scope="col" class="align-middle th-w-100">{{ knp_pagination_sortable(payments, 'Suivi', 'person.lastname') }}</th>
                            <th scope="col" class="align-middle th-w-100">{{ knp_pagination_sortable(payments, 'payment.type'|trans({}, 'forms'), 'p.type') }}</th>
                            <th scope="col" class="align-middle th-w-120">{{ knp_pagination_sortable(payments, 'Période de la PF', 'p.startDate') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Montant à régler', 'p.toPayAmt') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Montant réglé', 'p.paidAmt') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Restant dû (différentiel)', 'p.stillToPayAmt') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Date de l\'opération', 'p.paymentDate') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Mode de règlement', 'p.paymentType') }}</th>
                            <th scope="col" class="align-middle th-w-120">{{ knp_pagination_sortable(payments, 'Commentaire', 'p.comment') }}</th>
                            <th scope="col" class="align-middle th-w-100">{{ knp_pagination_sortable(payments, 'Service (Dispositif)', 's.name') }}</th>
                            <th scope="col" class="align-middle th-w-80">{{ knp_pagination_sortable(payments, 'Créé le', 'p.createdAt') }}</th>
                            <th scope="col" class="align-middle th-w-100">{{ knp_pagination_sortable(payments, 'Créé par', 'u.lastname') }}</th>
                        </tr>
                    </thead>
                    <tbody id="container-payments">
                        {% set toPayAmt = 0 %}
                        {% set paidAmt = 0 %}
                        {% for payment in payments %}
                            {% set person = (payment.supportGroup.supportPeople|first).person %}
                            <tr>
                                <td class="align-middle text-center">
                                    <a class="btn btn-{{ theme_color }} btn-sm shadow"
                                        href="{{ path('support_payments_index', {'id': payment.supportGroup.id, 'paymentId': payment.id}) }}"
                                        data-toggle="tooltip" data-placement="bottom" title="Voir {{ payment.typeToString }}"><span class="fas fa-eye"></span>
                                    </a>
                                </td>
                                <td class="align-middle">{{ person ? person.fullname }}</td>
                                <td class="align-middle">{{ payment.typeToString }}
                                    <span class="text-secondary">
                                        {{ payment.type == constant('RENT', payment) ? '(' ~ payment.rentAmt|amount ~ ')' }}<br/>
                                        {{ payment.type == constant('DEPOSIT_REFUNT', payment) ? '(' ~ payment.returnAmt|amount ~ ')' }}
                                    </span>
                                </td>
                                <td class="align-middle text-center">
                                    {% if payment.startDate %}
                                        {% set nbDays = payment.nbDays %}
                                        {{ payment.startDate|date('d/m/Y') }} - {{ payment.endDate|date('d/m/Y') }}
                                        <span class="small secondary">({{ nbDays }}&nbsp;jour{{ nbDays > 1 ? "s"}})</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-right">{{ payment.toPayAmt is not null ? payment.toPayAmt|amount }}</td>
                                <td class="align-middle text-right">{{ payment.paidAmt  is not null ? payment.paidAmt|amount }}</td>
                                <td class="align-middle text-right">{{ payment.stillToPayAmt ? payment.stillToPayAmt|amount }}</td>
                                <td class="align-middle text-center">{{ payment.paymentDate ? payment.paymentDate|date('d/m/Y') }}</td>
                                <td class="align-middle">{{ payment.paymentTypeToString }}</td>
                                <td class="align-middle small">
                                    {{ payment.noContrib ? 'PAF à zéro (' ~ payment.noContribReasonToString ~ ')' }}
                                    {{ (payment.comment ~ '\n' ~ payment.commentExport)|u.truncate(60, ' [...]', false) }}</td>
                                <td class="align-middle">{{ payment.supportGroup.service ? payment.supportGroup.service.name }}<br/>
                                    <span class="text-secondary">{{ payment.supportGroup.device ? '(' ~ payment.supportGroup.device.name ~ ')' }}</span>
                                </td>
                                <td class="align-middle">{{ payment.createdAt|date('d/m/Y') }}</td>
                                <td class="align-middle">{{ payment.createdBy.fullname }}</td>
                            </tr>
                            {% set toPayAmt = toPayAmt + payment.toPayAmt %}
                            {% set paidAmt = paidAmt + payment.paidAmt %}
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="font-weight-bold">
                            <td colspan="4" class="align-middle text-right">Sous-total (page)</td>
                            <td id="js-sumToPayAmt" class="align-middle text-right">{{ toPayAmt|amount }}</td>
                            <td id="js-sumPaidAmt" class="align-middle text-right">{{ paidAmt|amount }}</td>
                            <td id="js-sumStillToPayAmt" class="align-middle text-right ">{{ (toPayAmt - paidAmt)|amount }}</td>
                            <td colspan="6" class="align-middle text-center"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="navigation">{{ knp_pagination_render(payments) }}</div>

        </div>

    </section>

{% endblock %}

{% block javascripts %}
    {{ encore_entry_script_tags('search') }}
{% endblock javascripts %}